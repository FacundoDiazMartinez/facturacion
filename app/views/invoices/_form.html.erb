<%= nested_form_for @invoice do |form| %>
  <%= form.hidden_field :budget_id %>
  <%= error_explanation @invoice %>
  <!-- HEADER -->
    <div class="card   invoice-header">
      <div class="card-body">
        <div class="row">
          <!-- PRIMERA COLUMNA -->
            <div class="col-md-4">
              <div id="client_form">
                <%= render '/invoices/client_column' %>
              </div>
            </div>
            <%= form.hidden_field :client_id, value: @client.id %>
          <!-- PRIMERA COLUMNA -->

          <!-- SEGUNDA COLUMNA -->
            <div class="col-md-4">
              <div class="form-group row">
                <%= form.label :total, class:'col-4 col-form-label col-form-label-sm' %>
                <div class="col-8">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">$</span>
                    </div>
                    <%= form.text_field :total, class: 'form-control text-right', readonly: true %>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <%= form.label :total_pay, class:'col-4 col-form-label col-form-label-sm' %>
                <div class="col-8">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">$</span>
                    </div>
                    <%= form.text_field :total_pay, class: 'form-control text-right', readonly: true %>
                  </div>
                </div>
              </div>

              <div class="form-group row">
                <%= label_tag :total_left, "Monto faltante", class:'col-4 col-form-label col-form-label-sm' %>
                <div class="col-8">
                  <div class="input-group">
                    <div class="input-group-prepend">
                      <span class="input-group-text">$</span>
                    </div>
                    <%= text_field_tag :total_left, @invoice.total_left.round(2), class: 'form-control text-right',style: "font-weight: bold;", readonly: true %>
                  </div>
                </div>
              </div>
            </div>
          <!-- SEGUNDA COLUMNA -->

          <!-- TERCERA COLUMNA -->
          <div class="col-md-4">
            <div class="form-group row">
              <%= form.label :concepto, class:'col-4 col-form-label col-form-label-sm' %>
              <div class="col-8">
                <%= form.select :concepto, options_for_select(Company::CONCEPTOS, @invoice.concepto), {}, {class: 'form-control', disabled: !@invoice.editable?} %>
              </div>
            </div>
            <div class="form-group row">
              <%= form.label :sale_point_id, "Punto de venta", class:'col-4 col-form-label col-form-label-sm' %>
              <div class="col-8">
                <%= form.select :sale_point_id, options_for_select(current_user.company.sale_points.map{|sp| [sp.name, sp.id]}, @invoice.sale_point_id), {}, {class: 'form-control', disabled: !@invoice.
                editable?} %>
              </div>
            </div>
            <div class="form-group row">
              <%= form.label :cbte_tipo, "Tipo", class:'col-4 col-form-label col-form-label-sm' %>
              <div class="col-8">
                <%= form.select :cbte_tipo, options_for_select(Invoice.available_cbte_type(current_user.company, @client), form.object.cbte_tipo), {},{ class: 'form-control', disabled: !@invoice.editable?, autofocus: 'true'} %>
              </div>
            </div>
          </div>
          <!-- TERCERA COLUMNA -->
        </div>

        <div class="row" id="dynamic_attributes">
          <%= render '/invoices/dynamic_attributes', form: form %>
        </div>

      <!-- BOTONES DE ACCION -->
        <% if @invoice.confirmado? %>
        <div class="text-center">
            <hr class="invoice-header">
            <%= button_tag "#{icon('fas', 'envelope')} Enviar al cliente".html_safe, type: 'button', data:{toggle: 'modal', target: '#sendClientModal'}, class: 'btn btn-success' %>
        </div>
        <% end %>
        <!-- BOTONES DE ACCION -->
      </div>
    </div>
  <!-- HEADER -->

  <div id="idetails">
    <%= render template: '/invoices/detail/index.html.erb', locals: { form: form } %>
  </div>

  <div class="bonifications" style="display: none;" id="div_ibonifications">
    <%= render template: '/invoices/bonifications/index.html.erb', locals: { form: form } %>
  </div>

  <% if current_company.iva_cond == "Responsable Inscripto" %>
    <div class="tributes" style="display: none;" id="div_itributes">
      <%= render template: '/invoices/tributes/index.html.erb', locals: { form: form } %>
    </div>
  <% end %>

  <div class="authorized" style="display: none;" id="div_iauthorized">
    <%= render template: '/invoices/authorized/index.html.erb', locals: { form: form } %>
  </div>

  <!-- PAGOS -->
  <div id="ipayments">
    <%= render template: '/invoices/payment/index.html.erb', locals: { form: form } %>
  </div>
  <!-- PAGOS -->

  <div class="invoice-resume">
    <%= render 'resume', invoice: @invoice %>
  </div>

  <div class="text-center">
    <div hidden><%= check_box_tag :send_to_afip, true %></div>
    <div class="row">
      <div class="col-4">
      </div>
      <div class="col-4">
        <center>
          <%= button_tag "#{icon('fas', 'save')} Guardar".html_safe, type: 'submit', class: 'btn btn-success', id: 'save_btn_invoice', data: { disable_with: "#{icon('fas', 'sync')} Cargando...".html_safe } if @invoice.editable? %>
        </center>
      </div>
      <div class="col-4">
        <% if @invoice.editable? %>
          <%= button_tag "#{icon('fas', 'check-circle')} Confirmar".html_safe, type: 'button', onclick: 'openConfirmationModal()', class: 'btn btn-danger', style:'float: right;' %>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

<div class="modal fade bd-example-modal-lg" id="paymentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div id="payment_modal">
      </div>
    </div>
  </div>
</div>

<div class="modal fade bd-example-modal-lg" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div id="myModalContent" class="modal-content">
    </div>
  </div>
</div>

<div class="modal fade bd-example-modal-lg" id="confirm_invoice_modal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  	<div class="modal-dialog modal-lg">
    	<div class="modal-content">
      	<div id="confirmation_modal">
          <%= render '/invoices/confirmation_modal/confirm_invoice_content' %>
        </div>
  	  </div>
    </div>
</div>

<% if @invoice.state == "Confirmado" || @invoice.state == "Anulado" %>
  <div class="modal fade bd-example-modal-lg" id="sendClientModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="clientModalTitle"><%= icon('fas', 'users').html_safe %> Enviar factura a <%= @client.name %></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <%= form_tag deliver_invoice_path(@invoice.id),method: :get do %>
          <div class="modal-body">
            <h5>Enviar la factura NÂº <%= @invoice.full_number %></h5>
            <div class="form-group">
              <%= label_tag :email, "Email" %>
              <%= email_field_tag :email, @client.email, class: 'form-control', required: true %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            <%= save_button %>
          </div>
        <% end -%>
      </div>
    </div>
  </div>
<% else %>
  <div class="modal fade bd-example-modal-lg" id="sendToAfipModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div id="confirm_modal">
        </div>
      </div>
    </div>
  </div>
<% end -%>

<div class="modal fade bd-example-modal-lg" id="editPaymentModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div id="edit_payment_modal">
      </div>
    </div>
  </div>
</div>
<%= render '/invoices/detail/search_product' %>

<script>
  $(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
  });

  $(document).on("change", "select", function(){
  	$("#save_btn_invoice").attr("class","btn btn-danger");
  });

  $(document).on("keyup", "input:visible", function(){
  	$("#save_btn_invoice").attr("class","btn btn-danger");
  });

  $(document).on('nested:fieldRemoved', function(){
    $("#save_btn_invoice").attr("class","btn btn-danger");
  })
</script>
