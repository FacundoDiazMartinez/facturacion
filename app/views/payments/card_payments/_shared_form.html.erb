<div class="row">
  <div class="form-group col-6">
    <%= cpf.label :total, "Monto a pagar" %>
    <div class="input-group">
      <div class="input-group-prepend">
        <span class="input-group-text">$</span>
      </div>
      <%= cpf.number_field :total, class: 'form-control credit-card-amount fee-changer', required: true, step: '0.01' %>
    </div>
  </div>
  <div class="form-group col-6">
    <%= cpf.label :credit_card_id, "Tarjeta" %>
    <%= cpf.select :credit_card_id, current_user.company.credit_cards.map{ |cc| [cc.name, cc.id] }, { prompt: "Seleccione..." }, {class: 'form-control credit-card-select', required: true} %>
  </div>
</div>


<div class="form-group">
  <%= label_tag :cuotas, "Tabla de cuotas" %>
  <div class="card">
    <ul class="list-group list-group-flush">
      <% current_company.credit_cards.each do |credit_card| %>
        <div id="credit_card_<%= credit_card.id %>" class="fee-wrapper" style="display: none">
          <% credit_card.fees.order(:quantity).each do |cc| %>
          <li class="list-group-item fees">
            <span class="text-bold m-1 h6">
              <%= "#{cc.quantity}x " %>
            </span>
            <span class=" m1 h6">$
              <span class="fee-subtotal">
              </span>
            </span>
            <span class="m1 text-muted">
              (InterÃ©s <%= cc.percentage %>%)
            </span>
            <span class="float-right h6 text-muted">
              $<span class="fee-total"></span>
            </span>
            <%= hidden_field_tag :percentage, cc.percentage, class: 'percentage' %>
            <%= hidden_field_tag :quantity, cc.quantity, class: 'fee-quantity' %>
          </li>
          <% end %>
        </div>
      <% end %>
    </ul>
  </div>
</div>

<script type="text/javascript">
  $(document).ready(() => {
    changeFee()
  })

  $('.fee-changer').on('keyup change', () => { changeFee() })

  function changeFee() {
    let total = parseFloat($('.credit-card-amount').first().val())

    $('.percentage').each((index, currentField) => {
      let porcentaje  = parseFloat($(currentField).val())
      let auxTotal    = parseFloat((total * ((porcentaje / 100) + 1)).toFixed(2))
      let interes     = auxTotal - total
      let cantidadCuotas      = parseInt($(currentField).closest('li').find('.fee-quantity').val())

      $('#tributes > tbody > tr').each((index, currentField) => {
        setTaxesRowVars($(currentField))
        if (activo) { auxTotal += parseFloat((interes * ( alicuotaTax.val() / 100 )).toFixed(2))  }
      })

      let feeSubtotal = parseFloat((auxTotal / cantidadCuotas).toFixed(2))
      let feeTotal = feeSubtotal * cantidadCuotas

      $(currentField).closest('li').find('.fee-total').text(feeTotal.toFixed(2))
      $(currentField).closest('li').find('.fee-subtotal').text(feeSubtotal.toFixed(2))
    })
  }

  $('.credit-card-select').change((e) => {
    $('.fee-wrapper').css('display', 'none')
    if ($(e.target).val()) { $(`#credit_card_${$(e.target).val()}`).css('display', 'block') }
  })
</script>
